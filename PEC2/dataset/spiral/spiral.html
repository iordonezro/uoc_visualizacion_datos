<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico en Espiral</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    .spiral-line {
      fill: none;
      stroke-width: 2px;
    }

    .legend {
      font-size: 12px;
      font-family: sans-serif;
    }

    .filter-button {
      margin: 5px;
      padding: 5px 10px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .filter-button.active {
      background-color: #ccc;
    }

    .title {
      text-align: center;
      font-size: 18px;
      font-family: sans-serif;
      margin-bottom: 10px;
    }

    .footer {
      text-align: center;
      font-size: 12px;
      font-family: sans-serif;
      margin-top: 15px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="title">Indicadores de sostenibilidad: Variación interanual en la cifra de empleo (%) C.A. de Euskadi.</div>
  <div id="controls"></div>
  <script>
    const data = [
      { entidad: 'Araba/Álava', valores: [2.05, 0.73, -1.56, 0.66, 2.8, 2.14, 3.34, 1.56, -0.26, 0.54, -2.8, -1.83, -1.35, -3.71, 1.05, 3.77, 3.97, 1.8, 4.32, 2.48, 1.61] },
      { entidad: 'Bizkaia', valores: [1.71, -0.06, -1.38, 1.25, 2.59, 1.51, 2.38, 1.08, -0.95, -1.24, -2.15, -2.29, -1.6, -5.35, 1.63, 3.43, 4.33, 3.83, 4.07, 1.84, 2.63] },
      { entidad: 'Gipuzkoa', valores: [1.8, 0.45, -1.09, 1.17, 1.94, 2.02, 1.83, 1.26, -0.4, -0.39, -1.57, -1.36, -2.21, -4.72, 0.22, 2.55, 4.94, 2.53, 4.1, 1.16, 1.93] }
    ];

    const anyo = [2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016, 2015, 2014, 2013, 2012, 2011, 2010, 2009, 2008, 2007, 2006, 2005, 2004, 2003];

    const width = 800;
    const height = 800;
    const radius = Math.min(width, height) / 2 - 50;
    const svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", `translate(${width / 2}, ${height / 2})`);

    const angleScale = d3.scaleLinear().domain([0, anyo.length]).range([0, 2 * Math.PI]);
    const radiusScale = d3.scaleLinear().domain([-5, 5]).range([50, radius]);

    const colores = d3.scaleOrdinal(d3.schemeCategory10);

    let actividadEntidades = data.map(d => d.entidad);

    function renderSpiral() {
      svg.selectAll('.spiral-line').remove();
      data.filter(d => actividadEntidades.includes(d.entidad)).forEach((d, i) => {
        const line = d3.lineRadial()
          .angle((_, i) => angleScale(i))
          .radius(d => radiusScale(d))
          .curve(d3.curveCardinal);

        svg.append("path")
          .datum(d.valores)
          .attr("class", "spiral-line")
          .attr("stroke", colores(d.entidad))
          .attr("d", line)
          .attr("opacity", 0.7);
      });

      pintarLeyenda();
    }

    // Creación de filtros
    const controls = d3.select("#controls");
    data.forEach(d => {
      controls.append("button")
        .text(d.entidad)
        .attr("class", "filter-button")
        .classed("active", true)
        .on("click", function () {
          const index = actividadEntidades.indexOf(d.entidad);
          if (index === -1) {
            actividadEntidades.push(d.entidad);
          } else {
            actividadEntidades.splice(index, 1);
          }
          d3.select(this).classed("active", index === -1);
          renderSpiral();
        });
    });

    function pintarLeyenda() {
      svg.selectAll('.legend').remove();
      svg.selectAll('.legend')
        .data(data.filter(d => actividadEntidades.includes(d.entidad)))
        .enter().append('text')
        .attr('class', 'legend')
        .attr('x', 10)
        .attr('y', (_, i) => -height / 2 + 20 + i * 20)
        .attr('fill', d => colores(d.entidad))
        .text(d => d.entidad);
    }

    renderSpiral();
  </script>
  <div class="footer">
    Fuente: <a href="https://opendata.euskadi.eus/catalogo/-/indicadores-municipales-de-sostenibilidad-variacion-interanual-en-la-cifra-de-empleo/" target="_blank">https://opendata.euskadi.eus/catalogo/-/indicadores-municipales-de-sostenibilidad-variacion-interanual-en-la-cifra-de-empleo/</a>
  </div>
</body>
</html>
